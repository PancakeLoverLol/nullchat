<!DOCTYPE html>
<html>
<head>
  <title>NullChat</title>
  <style>
    body {
      background: #0e0e0e;
      color: #ccc;
      font-family: monospace;
      padding: 0;
      margin: 0;
    }
    #passwordScreen {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      background: #0e0e0e;
    }
    #mainContent {
      display: none;
      padding: 10px;
    }
    #messages {
      max-height: 60vh;
      overflow-y: auto;
      border: 1px solid #333;
      padding: 10px;
    }
    .msg {
      margin-bottom: 8px;
    }
    .username {
      color: #8af;
    }
    .timestamp {
      color: #777;
      font-size: 0.8em;
    }
    #typingStatus {
      font-size: 0.8em;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="passwordScreen">
    <input type="password" id="passwordInput" placeholder="Enter password" />
    <button onclick="checkPassword()">Enter</button>
  </div>

  <div id="mainContent">
    <h1>nullchat</h1>
    <div id="messages"></div>
    <input id="messageInput" placeholder="Say something..." />
    <button onclick="sendMessage()">Send</button>
    <div id="typingStatus"></div>
    <hr>
    <h3>Your Clan: <span id="yourClan">None</span></h3>
    <input id="newClanName" placeholder="Create new clan" />
    <button onclick="createClan()">Create Clan</button>
    <br><br>
    <input id="joinClanName" placeholder="Request to join clan" />
    <button onclick="requestJoinClan()">Request Join</button>
    <div id="joinRequests"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onChildAdded, push, set, remove, onValue, runTransaction, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDU7ocYo8pj-jq1JtBMy6aKlOS57ATvPlg",
      authDomain: "nullchat-e0243.firebaseapp.com",
      databaseURL: "https://nullchat-e0243-default-rtdb.firebaseio.com",
      projectId: "nullchat-e0243",
      storageBucket: "nullchat-e0243.appspot.com",
      messagingSenderId: "822668504447",
      appId: "1:822668504447:web:350ff354d5b13f8cc8fe4a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let username = localStorage.getItem("nullchat_user");

    if (!username) {
      const countRef = ref(db, "userCount");
      runTransaction(countRef, current => (current || 0) + 1).then(({ snapshot }) => {
        username = `null_${snapshot.val()}`;
        localStorage.setItem("nullchat_user", username);
      });
    }

    const password = "nullpass";

    window.checkPassword = function () {
      const input = document.getElementById("passwordInput").value;
      if (input === password) {
        document.getElementById("passwordScreen").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
      } else {
        alert("Wrong password");
      }
    }

    const messageInput = document.getElementById("messageInput");
    const messagesDiv = document.getElementById("messages");
    const typingStatus = document.getElementById("typingStatus");

    const admins = ["null_1"];

    function isAdmin() {
      return admins.includes(username);
    }

    onChildAdded(ref(db, "messages"), snap => {
      const { text, time, user } = snap.val();
      const key = snap.key;

      const div = document.createElement("div");
      div.className = "msg";

      const canDelete = user === username || isAdmin();

      div.innerHTML = `<div><span class="username">${user}</span>: ${text} ${canDelete ? `<button onclick="deleteMessage('${key}')">âœ–</button>` : ''}</div><div class="timestamp">${time}</div>`;

      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    function sendMessage() {
      const text = messageInput.value;
      if (!text.trim()) return;
      const time = new Date().toLocaleTimeString();

      push(ref(db, "messages"), { user: username, text, time });
      messageInput.value = "";
      update(ref(db), { typing: null });
    }

    window.sendMessage = sendMessage;

    window.deleteMessage = function (key) {
      if (confirm("Delete this message?")) {
        remove(ref(db, "messages/" + key));
      }
    }

    messageInput.addEventListener("input", () => {
      update(ref(db), { typing: username });
    });

    onValue(ref(db, "typing"), snap => {
      const val = snap.val();
      typingStatus.textContent = val && val !== username ? `${val} is typing...` : "";
    });

    // Clan features
    const clanDisplay = document.getElementById("yourClan");

    onValue(ref(db, `clans_users/${username}`), snap => {
      clanDisplay.textContent = snap.val() || "None";
    });

    window.createClan = function () {
      const name = document.getElementById("newClanName").value.trim();
      if (!name) return;
      set(ref(db, `clans/${name}/owner`), username);
      set(ref(db, `clans_users/${username}`), name);
    }

    window.requestJoinClan = function () {
      const name = document.getElementById("joinClanName").value.trim();
      if (!name) return;
      push(ref(db, `clan_requests/${name}`), username);
      alert("Request sent!");
    }

    onValue(ref(db, `clans`), snap => {
      const clans = snap.val();
      for (let clanName in clans) {
        if (clans[clanName].owner === username) {
          onValue(ref(db, `clan_requests/${clanName}`), requestSnap => {
            const reqs = requestSnap.val();
            const div = document.getElementById("joinRequests");
            div.innerHTML = `<h4>Requests to join ${clanName}:</h4>`;
            for (let key in reqs) {
              const user = reqs[key];
              const p = document.createElement("p");
              p.innerHTML = `${user} <button onclick="approveRequest('${clanName}','${key}','${user}')">Approve</button>`;
              div.appendChild(p);
            }
          });
        }
      }
    });

    window.approveRequest = function (clanName, key, user) {
      set(ref(db, `clans_users/${user}`), clanName);
      remove(ref(db, `clan_requests/${clanName}/${key}`));
    }

  </script>
</body>
</html>
